name: Automations

on:
  # For: fast-forward
  check_suite:
    types: [completed]
  # For: fast-forward
  pull_request_review:
    types: [submitted]
  # For: auto-approve, fast-forward
  pull_request_target:
    types: [labeled]

jobs:
  auto-approve:
    name: Auto-Approve
    runs-on: ubuntu-latest

    if: github.event_name == 'pull_request_target' &&
      (github.actor == 'renovate[bot]' || contains(github.event.pull_request.labels.*.name, 'ðŸ‘ ship!'))

    permissions:
      pull-requests: write

    steps:
      - name: Approve
        run: |
          pr_number=${{ github.event.pull_request.number }}
          decision=$(gh pr view "$pr_number" --json reviewDecision --jq ".reviewDecision")
          echo "Current review decision: $decision"

          if [[ "$decision" == "REVIEW_REQUIRED" ]]; then
            gh pr review "$pr_number" --approve --body "Ship it! :shipit:"
            echo "Approved!"
          else
            echo "Skipped."
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository_owner }}/${{ github.event.repository.name }}

  fast-forward:
    name: Fast-Forward
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write
      issues: write

    if: |
      ((github.event_name == 'pull_request_target' || github.event_name == 'pull_request_review') &&
        contains(github.event.pull_request.labels.*.name, '--ff-only')) ||
      (github.event_name == 'check_suite' && github.event.check_suite.pull_requests[0] != null &&
        github.event.check_suite.conclusion == 'success')

    steps:
      - name: Find PR number
        run: |
          if [[ "${{ github.event_name }}" == "check_suite" ]]; then
            # For check_suite events, get PR number from associated pull requests
            pr_number=${{ github.event.check_suite.pull_requests[0].number }}
          else
            # For pull_request_* events, get PR number directly
            pr_number=${{ github.event.pull_request.number }}
          fi
          
          if [[ -z "$pr_number" ]]; then
            echo "âŒ Could not find PR number"
            exit 1
          fi
          
          echo "PR_NUMBER=$pr_number" >> $GITHUB_ENV
          echo "âœ… Found PR number: $pr_number"

      - name: Extract PR properties
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = parseInt(process.env.PR_NUMBER);
            const {data: pr} = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            
            console.log(`PR #${pr.number}: ${pr.title}`);
            console.log(`Mergeable state: ${pr.mergeable_state}`);

            const labels = pr.labels.map(label => label.name);
            console.log('PR labels:', labels);

            core.setOutput('mergeable_state', pr.mergeable_state);
            core.setOutput('has_ff_label', labels.includes('--ff-only'));

      - name: Fast forwarding
        uses: sequoia-pgp/fast-forward@v1
        if: steps.pr.outputs.mergeable_state == 'clean' && steps.pr.outputs.has_ff_label == 'true'
        with:
          merge: true
