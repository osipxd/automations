name: Automations

on:
  # For: fast-forward
  check_run:
    types: [completed]
  # For: fast-forward
  pull_request_review:
    types: [submitted]
  # For: auto-approve, fast-forward
  pull_request_target:
    types: [labeled]

env:
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  GH_REPO: ${{ github.repository }}
  PR_NUMBER: ${{ github.event_name == 'check_run' && github.event.check_run.pull_requests[0].number || github.event.pull_request.number }}

jobs:
  auto-approve:
    name: Auto-Approve
    runs-on: ubuntu-latest

    if: github.event_name == 'pull_request_target' &&
      (github.actor == 'renovate[bot]' || github.event.label.name == '👍 ship!')

    permissions:
      pull-requests: write

    steps:
      - name: Approve
        run: |
          decision=$(gh pr view "$PR_NUMBER" --json reviewDecision --jq ".reviewDecision")
          echo "Current review decision: $decision"

          if [[ "$decision" == "REVIEW_REQUIRED" ]]; then
            gh pr review "$PR_NUMBER" --approve --body "Ship it! :shipit:"
            echo "Approved!"
          else
            echo "Skipped."
          fi
      - name: Add '--ff-only' label to renovate PRs
        if: github.actor == 'renovate[bot]'
        run: |
          gh pr edit "$PR_NUMBER" --add-label "--ff-only"
          echo "✅ Added '--ff-only' label to the PR #$PR_NUMBER"

  fast-forward:
    name: Fast-Forward
    runs-on: ubuntu-latest

    if: |
      (github.event_name == 'pull_request_target' && github.event.label.name == '--ff-only') ||
      (github.event_name == 'pull_request_review' && github.event.review.state == 'approved') ||
      (github.event_name == 'check_run' && github.event.check_run.pull_requests[0] != null &&
        github.event.check_run.conclusion == 'success')

    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Extract PR properties
        id: pr
        run: |
          pr_data=$(gh pr view "$PR_NUMBER" --json title,mergeStateStatus,labels)

          title=$(echo "$pr_data" | jq -r '.title')
          merge_state_status=$(echo "$pr_data" | jq -r '.mergeStateStatus')
          has_ff_label=$(echo "$pr_data" | jq -r 'any(.labels[]; .name == "--ff-only")')

          echo "PR #$PR_NUMBER: $title"
          echo "Mergeable state: $merge_state_status"
          echo "Has '--ff-only' label: $has_ff_label"

          echo "merge_state_status=$merge_state_status" >> $GITHUB_OUTPUT
          echo "has_ff_label=$has_ff_label" >> $GITHUB_OUTPUT

      - name: Fast forwarding
        uses: sequoia-pgp/fast-forward@v1
        if: steps.pr.outputs.has_ff_label == 'true' &&
          (steps.pr.outputs.merge_state_status == 'CLEAN' || steps.pr.outputs.merge_state_status == 'UNSTABLE')
        with:
          merge: true
